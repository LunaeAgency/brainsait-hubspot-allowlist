user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # HubSpot Allowlist - All Regions
    # NA1 Region
    geo $hubspot_na1 {
        default 0;
        54.174.61.34/32 1;
        54.174.61.33/32 1;
        54.174.61.30/32 1;
        54.174.52.6/31 1;
        54.174.59.92/31 1;
        158.247.22.206/31 1;
        143.244.91.196/32 1;
        54.174.59.200/32 1;
    }

    # EU1 Region
    geo $hubspot_eu1 {
        default 0;
        143.244.84.208/31 1;
        143.244.84.204/31 1;
        143.244.84.216/32 1;
        143.244.84.200/31 1;
        143.244.84.212/32 1;
    }

    # AP1 Region
    geo $hubspot_ap1 {
        default 0;
        216.139.84.191/32 1;
        216.139.84.193/32 1;
        216.139.84.197/32 1;
        216.139.84.189/32 1;
        216.139.84.195/32 1;
    }

    # NA2 Region
    geo $hubspot_na2 {
        default 0;
        216.139.64.210/32 1;
        216.139.64.209/32 1;
        216.139.64.214/32 1;
        216.139.64.213/32 1;
        216.139.64.219/32 1;
        216.139.64.206/32 1;
        216.139.64.205/32 1;
        216.139.64.217/32 1;
    }

    # NA3 Region
    geo $hubspot_na3 {
        default 0;
        216.139.80.191/32 1;
        216.139.80.193/32 1;
        216.139.80.197/32 1;
        216.139.80.189/32 1;
        216.139.80.195/32 1;
    }

    # Notification Services
    geo $hubspot_notifications {
        default 0;
        158.247.24.220/32 1;
        158.247.26.235/32 1;
        158.247.25.83/32 1;
        143.244.84.220/32 1;
        216.139.84.180/32 1;
        216.139.64.196/32 1;
        216.139.80.180/32 1;
        108.179.150.64/27 1;
        108.179.153.100/30 1;
        108.179.150.0/27 1;
        3.93.157.86/31 1;
        18.208.124.253/32 1;
        18.208.124.254/32 1;
    }

    # Main server block
    server {
        listen 80;
        listen [::]:80;
        server_name _;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # HubSpot webhook endpoint
        location /hubspot/webhook {
            # Allow all HubSpot IPs
            if ($hubspot_na1 = 0) {
                if ($hubspot_eu1 = 0) {
                    if ($hubspot_ap1 = 0) {
                        if ($hubspot_na2 = 0) {
                            if ($hubspot_na3 = 0) {
                                if ($hubspot_notifications = 0) {
                                    return 403;
                                }
                            }
                        }
                    }
                }
            }

            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default location
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }

    # HTTPS server block (when SSL is configured)
    # server {
    #     listen 443 ssl http2;
    #     listen [::]:443 ssl http2;
    #     server_name your-domain.com;
    #
    #     ssl_certificate /etc/nginx/ssl/fullchain.pem;
    #     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    #
    #     location / {
    #         # Same configuration as above
    #     }
    # }
}
